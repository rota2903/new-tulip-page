<script>
  // === CONFIGURATION ===
  const UNIT_ID = 'unit1';
  const ADMIN_PASSWORD = '9TulipsCH';
  const JSON_URL = 'unit1.json';  // Loads from same folder
  const REPO_PATH = 'rota2903/new-tulip-page';
  const FILE_PATH = 'tulip1/unit1.json';  // Path from repo root
  const GITHUB_TOKEN = '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'; // ‚Üê Paste NEW token here after generating

  // === STATE ===
  let adminSelectedDates = [];
  let isAdminMode = false;
  let sharedData = { bookings: [], locked: [] };

  // === DOM Elements ===
  const calendar = document.getElementById('calendar');
  const adminCalendar = document.getElementById('adminCalendar');
  const adminPanel = document.getElementById('adminPanel');
  const adminContent = document.getElementById('adminContent');
  const adminPass = document.getElementById('adminPass');

  // === 1. Load Data from GitHub ===
  async function loadData() {
    try {
      const res = await fetch(JSON_URL + '?t=' + new Date().getTime()); // Cache buster
      sharedData = await res.json();
      generateCalendar();
    } catch (err) {
      console.error("Failed to load booking data", err);
      calendar.innerHTML = `<p style="color:red;">‚ö†Ô∏è Could not load calendar. Check your internet or try again later.</p>`;
    }
  }

  // === 2. Save Data to GitHub ===
  async function saveData(message) {
    if (!GITHUB_TOKEN) {
      alert("‚ùå GitHub token not set. Cannot save.");
      return false;
    }

    try {
      // Get current file info (SHA)
      const getRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`);
      if (!getRes.ok) throw new Error(`Fetch failed: ${getRes.status}`);
      const json = await getRes.json();
      const sha = json.sha;

      // Prepare updated content
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(sharedData, null, 2))));

      // Update file
      const putRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,  // ‚úÖ Use Bearer for fine-grained token
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: message,
          content: content,
          sha: sha,
          committer: {
            name: "TULIP Admin",
            email: "admin@tulip.com"
          }
        })
      });

      if (putRes.ok) {
        console.log("‚úÖ Saved to GitHub");
        return true;
      } else {
        const err = await putRes.json();
        console.error("Save failed:", err);
        alert("‚ùå Save failed: " + err.message);
        return false;
      }
    } catch (err) {
      console.error("Network error:", err);
      alert("‚ùå Network error. Could not save.");
      return false;
    }
  }

  // === 3. Generate Calendar (User View) ===
  function generateCalendar() {
    const today = new Date();
    const bookings = sharedData.bookings || [];
    const lockedDates = sharedData.locked || [];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    calendar.innerHTML = '';
    for (let m = 0; m < 3; m++) {
      const monthDate = new Date(today.getFullYear(), today.getMonth() + m);
      const month = monthDate.getMonth();
      const year = monthDate.getFullYear();

      const monthHeader = document.createElement('h3');
      monthHeader.textContent = `${monthNames[month]} ${year}`;
      monthHeader.style = "margin: 20px 0 10px 0; color: #2c3e50;";
      calendar.appendChild(monthHeader);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let row = document.createElement('tr');

      for (let i = 0; i < firstDay; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty';
        row.appendChild(cell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('td');
        cell.textContent = day;

        const dateObj = new Date(year, month, day);
        const dateStr = dateObj.toISOString().split('T')[0];

        if (dateObj < today && dateObj.setHours(0,0,0,0) < today.setHours(0,0,0,0)) {
          cell.className = 'past';
        } else {
          if (lockedDates.includes(dateStr)) {
            cell.className = 'locked';
            cell.title = "Locked";
          } else {
            const booking = bookings.find(b => b.dates.includes(dateStr));
            if (booking && booking.status === 'approved') {
              cell.className = 'approved';
              const info = document.createElement('div');
              info.className = 'booking-info';
              info.textContent = booking.name;
              cell.appendChild(info);
            } else if (booking && booking.status === 'pending') {
              cell.className = 'pending';
            } else {
              cell.className = 'open';
            }
          }
        }
        row.appendChild(cell);
        if ((day + firstDay) % 7 === 0 || day === daysInMonth) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }
      }
      table.appendChild(tbody);
      calendar.appendChild(table);
    }

    if (isAdminMode) generateAdminCalendar();
  }

  // === 4. Admin Calendar (with selection) ===
  function generateAdminCalendar() {
    const today = new Date();
    const bookings = sharedData.bookings || [];
    const lockedDates = sharedData.locked || [];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    adminCalendar.innerHTML = '';

    for (let m = 0; m < 3; m++) {
      const monthDate = new Date(today.getFullYear(), today.getMonth() + m);
      const month = monthDate.getMonth();
      const year = monthDate.getFullYear();

      const monthHeader = document.createElement('h3');
      monthHeader.textContent = `${monthNames[month]} ${year}`;
      monthHeader.style = "margin: 20px 0 10px 0; color: #2c3e50;";
      adminCalendar.appendChild(monthHeader);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let row = document.createElement('tr');

      for (let i = 0; i < firstDay; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty';
        row.appendChild(cell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('td');
        cell.textContent = day;

        const dateObj = new Date(year, month, day);
        const dateStr = dateObj.toISOString().split('T')[0];

        if (dateObj < today && dateObj.setHours(0,0,0,0) < today.setHours(0,0,0,0)) {
          cell.className = 'past';
        } else {
          if (lockedDates.includes(dateStr)) {
            cell.className = 'locked';
          } else {
            const booking = bookings.find(b => b.dates.includes(dateStr));
            if (booking && booking.status === 'approved') {
              cell.className = 'approved';
            } else if (booking && booking.status === 'pending') {
              cell.className = 'pending';
            } else {
              cell.className = 'open';
            }
          }
        }

        cell.onclick = () => {
          if (cell.classList.contains('selected')) {
            cell.classList.remove('selected');
            adminSelectedDates = adminSelectedDates.filter(d => d !== dateStr);
          } else {
            cell.classList.add('selected');
            adminSelectedDates.push(dateStr);
          }
        };

        row.appendChild(cell);
        if ((day + firstDay) % 7 === 0 || day === daysInMonth) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }
      }
      table.appendChild(tbody);
      adminCalendar.appendChild(table);
    }
  }

  // === 5. Admin Functions ===
  function checkPassword() {
    if (adminPass.value === ADMIN_PASSWORD) {
      isAdminMode = true;
      adminPass.style.display = 'none';
      document.querySelector('#adminPanel button').style.display = 'none';
      adminContent.style.display = 'block';
      loadAllBookings();
      generateCalendar();
    } else {
      alert("‚ùå Wrong password!");
    }
  }

  function logout() {
    isAdminMode = false;
    adminContent.style.display = 'none';
    adminPass.style.display = 'block';
    adminPass.value = '';
    document.querySelector('#adminPanel button').style.display = 'inline-block';
    adminSelectedDates = [];
    generateCalendar();
  }

  function loadAllBookings() {
    const bookings = sharedData.bookings || [];
    const pending = bookings.filter(b => b.status === 'pending');
    const approved = bookings.filter(b => b.status === 'approved');

    const pendingDiv = document.getElementById('pendingList');
    pendingDiv.innerHTML = pending.length ? '' : '<p>No pending bookings.</p>';
    pending.forEach(b => {
      const item = document.createElement('div');
      item.innerHTML = `
        <strong>${b.name}</strong> (${b.phone})<br>
        ${b.dates.join(', ')}<br>
        <button onclick="approve(${b.id})">‚úÖ Approve</button>
        <button onclick="reject(${b.id})" class="btn-delete">üóëÔ∏è Delete</button>
        <hr>
      `;
      pendingDiv.appendChild(item);
    });

    const approvedDiv = document.getElementById('approvedList');
    approvedDiv.innerHTML = approved.length ? '' : '<p>No approved bookings.</p>';
    approved.forEach(b => {
      const item = document.createElement('div');
      item.innerHTML = `
        <strong>‚úÖ ${b.name}</strong><br>
        üìû ${b.phone}<br>
        üìÖ ${b.dates.join(', ')}<br>
        <button onclick="unapprove(${b.id})" class="btn-delete">üóëÔ∏è Cancel</button>
        <hr>
      `;
      approvedDiv.appendChild(item);
    });
  }

  async function approve(id) {
    const b = sharedData.bookings.find(b => b.id == id);
    if (!b) return;

    const conflict = sharedData.bookings.some(book =>
      book.status === 'approved' &&
      book.dates.some(d => b.dates.includes(d))
    );
    if (conflict) return alert("‚ùå Dates already booked.");

    const overlapping = sharedData.bookings.filter(p =>
      p.status === 'pending' && p.id != id &&
      p.dates.some(d => b.dates.includes(d))
    );

    b.status = 'approved';
    sharedData.bookings = sharedData.bookings.filter(book =>
      !overlapping.some(p => p.id === book.id)
    );

    const saved = await saveData(`Approved: ${b.name}`);
    if (saved) {
      alert(`‚úÖ Approved. ${overlapping.length} pending canceled.`);
      loadAllBookings();
      generateCalendar();
    }
  }

  async function reject(id) {
    sharedData.bookings = sharedData.bookings.filter(b => b.id != id);
    const saved = await saveData("Rejected booking");
    if (saved) {
      alert("üóëÔ∏è Booking deleted.");
      loadAllBookings();
      generateCalendar();
    }
  }

  async function unapprove(id) {
    sharedData.bookings = sharedData.bookings.filter(b => b.id != id);
    const saved = await saveData("Canceled booking");
    if (saved) {
      alert("‚ùå Booking canceled.");
      loadAllBookings();
      generateCalendar();
    }
  }

  async function lockSelectedDates() {
    if (adminSelectedDates.length === 0) return alert("Select dates to lock.");
    sharedData.locked = [...new Set([...sharedData.locked, ...adminSelectedDates])];
    const saved = await saveData(`Locked ${adminSelectedDates.length} dates`);
    if (saved) {
      alert("‚úÖ Locked.");
      adminSelectedDates = [];
      generateCalendar();
    }
  }

  async function unlockSelectedDates() {
    if (adminSelectedDates.length === 0) return alert("Select dates to unlock.");
    sharedData.locked = sharedData.locked.filter(d => !adminSelectedDates.includes(d));
    const saved = await saveData(`Unlocked ${adminSelectedDates.length} dates`);
    if (saved) {
      alert("üîì Unlocked.");
      adminSelectedDates = [];
      generateCalendar();
    }
  }

  // === Initialize ===
  loadData();
</script>
