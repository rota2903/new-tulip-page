<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unit Calendar</title>
  <style>
    body {{ font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin:auto; }}
    h1 {{ color: #2c3e50; }}
    table {{ width:100%; border-collapse: collapse; margin:20px 0; }}
    th, td {{ border:1px solid #ccc; padding:8px; text-align:center; }}
    .past {{ background:#ccc; color:#777; }}
    .open {{ background:#2ecc71; color:white; }}
    .locked {{ background:#95a5a6; color:white; }}
    .back-btn {{ display:inline-block; margin-bottom:20px; padding:10px 15px; background:#007bff; color:#fff; text-decoration:none; border-radius:5px; }}
  </style>
</head>
<body>
  <a href="https://rota2903.github.io/new-tulip-page" class="back-btn">‚Üê Back to Units</a>
  <h1>üìÖ Availability Calendar</h1>
  <div id="calendar"></div>
  <div id="adminPanel">
    <h2>üîê Admin Login</h2>
    <input type="password" id="adminPass" placeholder="Enter Password" />
    <button onclick="checkPassword()">Login</button>
    <div id="adminContent" style="display:none;">
      <p><button onclick="logout()">Logout</button></p>
    </div>
  </div>

<script>
const BIN_ID = "68ae6cef43b1c97be92c41f6";
const API_URL = `https://api.jsonbin.io/v3/b/${{BIN_ID}}`;
const MASTER_KEY = ""; // public read-only
const ADMIN_PASSWORD = "9TulipsCH";

let isAdminMode = false;
let bookings = [];

async function loadBookings() {{
  try {{
    const res = await fetch(API_URL, {{ headers: {{ "X-Master-Key": MASTER_KEY }} }});
    const data = await res.json();
    bookings = data.record || [];
    renderCalendar();
  }} catch (e) {{
    document.getElementById('calendar').innerHTML = "‚ö†Ô∏è Cannot load calendar.";
  }}
}}

function renderCalendar() {{
  const calendar = document.getElementById('calendar');
  const today = new Date();
  calendar.innerHTML = "";

  for (let m=0; m<3; m++) {{
    const monthDate = new Date(today.getFullYear(), today.getMonth()+m, 1);
    const year = monthDate.getFullYear();
    const month = monthDate.getMonth();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    const monthName = monthDate.toLocaleString('default', {{ month:'long' }});
    const h3 = document.createElement('h3');
    h3.textContent = monthName + " " + year;
    calendar.appendChild(h3);

    const table = document.createElement('table');
    const header = document.createElement('tr');
    header.innerHTML = "<th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>";
    table.appendChild(header);

    let row = document.createElement('tr');
    const firstDay = new Date(year, month, 1).getDay();
    for (let i=0; i<firstDay; i++) row.appendChild(document.createElement('td'));

    for (let d=1; d<=daysInMonth; d++) {{
      const cell = document.createElement('td');
      cell.textContent = d;
      const dateStr = `${{year}}-${{String(month+1).padStart(2,'0')}}-${{String(d).padStart(2,'0')}}`;

      let status = bookings.find(b => b.date === dateStr)?.status || "open";
      if (new Date(dateStr) < new Date().setHours(0,0,0,0)) status = "past";

      cell.className = status;

      if (isAdminMode && status !== "past") {{
        cell.onclick = () => toggleDate(dateStr, status);
      }}
      row.appendChild(cell);
      if ((d+firstDay)%7===0 || d===daysInMonth) {{
        table.appendChild(row);
        row = document.createElement('tr');
      }}
    }}
    calendar.appendChild(table);
  }}
}}

async function toggleDate(dateStr, currentStatus) {{
  let newStatus = currentStatus==="locked" ? "open" : "locked";
  bookings = bookings.filter(b => b.date !== dateStr);
  bookings.push({{ date: dateStr, status: newStatus }});
  await saveBookings();
  renderCalendar();
}}

async function saveBookings() {{
  await fetch(API_URL, {{
    method: "PUT",
    headers: {{ "Content-Type":"application/json", "X-Master-Key": MASTER_KEY }},
    body: JSON.stringify(bookings)
  }});
}}

function checkPassword() {{
  const pass = document.getElementById('adminPass').value;
  if (pass === ADMIN_PASSWORD) {{
    isAdminMode = true;
    document.getElementById('adminContent').style.display = "block";
    document.getElementById('adminPass').style.display = "none";
  }} else {{
    alert("Wrong password");
  }}
}}

function logout() {{
  isAdminMode = false;
  document.getElementById('adminContent').style.display = "none";
  document.getElementById('adminPass').style.display = "block";
}}

loadBookings();
</script>
</body>
</html>
